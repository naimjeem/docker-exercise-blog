name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME || 'localhost' }}
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME || 'localhost' }}/todo-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME || 'localhost' }}/todo-frontend

jobs:
  # Job 1: Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Check Docker availability
        run: |
          echo "Checking Docker availability..."
          docker --version || echo "Docker not available"
          docker-compose --version || echo "Docker Compose not available"
          docker info || echo "Docker daemon not running"

      - name: Log in to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set Release Version
        run: |
          if ("${{ github.ref }}" -like "refs/tags/*") {
            $tagVersion = "${{ github.ref }}" -replace "refs/tags/", ""
            echo "RELEASE_VERSION=$tagVersion" >> $GITHUB_ENV
            echo "Using tag version: $tagVersion"
          } else {
            echo "RELEASE_VERSION=latest" >> $GITHUB_ENV
            echo "Using version: latest"
          }
          echo "RELEASE_VERSION value: $RELEASE_VERSION"

      - name: Build & Push Backend
        run: |
          $VERSION = "${{ env.RELEASE_VERSION }}"
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "latest" }
          echo "Building backend image: ${{ env.BACKEND_IMAGE }}:$VERSION"
          docker build -t "${{ env.BACKEND_IMAGE }}:$VERSION" ./backend || echo "Backend build failed"
          docker push "${{ env.BACKEND_IMAGE }}:$VERSION" || echo "Backend push failed"

      - name: Build & Push Frontend
        run: |
          $VERSION = "${{ env.RELEASE_VERSION }}"
          if ([string]::IsNullOrEmpty($VERSION)) { $VERSION = "latest" }
          echo "Building frontend image: ${{ env.FRONTEND_IMAGE }}:$VERSION"
          docker build -t "${{ env.FRONTEND_IMAGE }}:$VERSION" ./frontend || echo "Frontend build failed"
          docker push "${{ env.FRONTEND_IMAGE }}:$VERSION" || echo "Frontend push failed"

  # Job 2: Deploy Application
  deploy:
    name: Deploy Application
    runs-on: self-hosted
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Create .env file from template
        run: |
          echo "Creating .env file from env.example..."
          Copy-Item env.example .env
          echo "Created .env file with default values"

      - name: Set Release Version for Deploy
        run: |
          if ("${{ github.ref }}" -like "refs/tags/*") {
            $tagVersion = "${{ github.ref }}" -replace "refs/tags/", ""
            echo "RELEASE_VERSION=$tagVersion" >> $GITHUB_ENV
            echo "Using tag version for deploy: $tagVersion"
          } else {
            echo "RELEASE_VERSION=latest" >> $GITHUB_ENV
            echo "Using latest version for deploy"
          }

      - name: Update .env with new RELEASE_VERSION
        run: |
          echo "Setting RELEASE_VERSION=${{ env.RELEASE_VERSION }} in .env"

          # Update .env with RELEASE_VERSION using PowerShell
          powershell -Command "
            Get-Content .env | Where-Object { $_ -notmatch '^RELEASE_VERSION=' } | Out-File .env.tmp
            Add-Content .env.tmp 'RELEASE_VERSION=${{ env.RELEASE_VERSION }}'
            Move-Item .env.tmp .env
            Write-Host 'Final .env:'
            Get-Content .env
          "

      - name: Clean up existing containers
        run: |
          echo "Cleaning up existing containers..."
          docker compose down --remove-orphans || echo "No existing containers to remove"
          docker container prune -f || echo "Container cleanup failed"
          docker network prune -f || echo "Network cleanup failed"

      - name: Deploy locally with Docker Compose
        run: |
          echo "Deploying with Docker Compose..."
          docker compose pull || echo "Docker Compose pull failed"
          docker compose up -d --force-recreate || echo "Docker Compose up failed"
          echo "Deployment completed (with potential errors)"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          docker compose ps || echo "Could not check container status"
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "Frontend: http://localhost:3000"
          echo "Backend API: http://localhost:5000"
          echo "Nginx Proxy: http://localhost:80"
          echo "Health Check: http://localhost:5000/health"